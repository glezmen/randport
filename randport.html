<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAy2KEPqokTlkhz0d7IcXkpp8rzkAduhco" async defer></script>
		<!-- PapaParse for CSV parsing -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
		<title>Random Airport Selector</title>
		<style>

			#map {
				height: 500px;
				width: 100%;
			}

			body {
				font-family: Arial, sans-serif;
				margin: 20px;
				line-height: 1.6;
				background-color: #f9f9f9;
				color: #333;
			}

			h1 {
				color: #0056b3;
			}

			label {
				display: block;
				margin-bottom: 10px;
			}

			select, input[type="checkbox"] {
				margin-right: 10px;
			}

			button {
				background-color: #0056b3;
				color: white;
				border: none;
				padding: 10px 20px;
				border-radius: 5px;
				cursor: pointer;
			}

			button:hover {
				background-color: #003d82;
			}

			#result {
				margin-top: 20px;
				padding: 10px;
				border: 1px solid #ccc;
				background-color: #fff;
				border-radius: 5px;
				width: fit-content;
			}

			.highlight {
				font-weight: bold;
				color: #0056b3;
			}
		</style>

		<script>
			let data = [];
			let countries = {};
			let filteredData = [];
			let lastcoord = { lat: 0, lon: 0 };

			async function loadCountries() {
				const response = await fetch('https://davidmegginson.github.io/ourairports-data/countries.csv');
				const csvText = await response.text();

				console.log("Load countries");
				const parsedData = Papa.parse(csvText, { header: true, skipEmptyLines: true });

				parsedData.data.forEach(row => {
					countries[row.code] = row.name;
				})
			}

			async function loadCSV() {
				console.log("Load airport DB");
				document.getElementById("result").innerHTML = "<strong>Loading...</strong>";
				const response = await fetch('https://davidmegginson.github.io/ourairports-data/airports.csv');
				const csvText = await response.text();

				const parsedData = Papa.parse(csvText, { header: true, skipEmptyLines: true });
				data = parsedData.data.map(row => ({
					id: row.id,
					ident: row.ident,
					type: row.type,
					name: row.name,
					latitude_deg: row.latitude_deg,
					longitude_deg: row.longitude_deg,
					iata_code: row.iata_code,
					local_code: row.local_code,
					continent: row.continent,
					iso_country: row.iso_country,
					iso_region: row.iso_region,
					home_link: row.home_link,
					wikipedia_link: row.wikipedia_link
				}));

				await loadCountries();
				populateFilters();

				console.log("Data load complete");
				document.getElementById("result").innerHTML = "<strong>Ready</strong>";
			}

			function clearFilter() {
				document.getElementById("iataFilter").checked = false;
				document.getElementById("balloonFilter").checked = false;
				document.getElementById("heliportFilter").checked = false;
				document.getElementById("openFilter").checked = false;
				document.getElementById("seaplaneFilter").checked = false;
				document.getElementById("minSize").value = "All";
				document.getElementById("countryFilter").value = "";
				document.getElementById("continentFilter").value = "";
				filter();
			}

			function filter() {
				const iataFilter = document.getElementById("iataFilter").checked;
				const balloonFilter = document.getElementById("balloonFilter").checked;
				const heliportFilter = document.getElementById("heliportFilter").checked;
				const openFilter = document.getElementById("openFilter").checked;
				const seaplaneFilter = document.getElementById("seaplaneFilter").checked;
				const minSize = document.getElementById("minSize").value;
				const countryFilter = document.getElementById("countryFilter").value;
				const continentFilter = document.getElementById("continentFilter").value;

				filteredData = data;

				if (iataFilter) {
					filteredData = filteredData.filter(row => row.iata_code !== "");
				}

				if (!balloonFilter) {
					filteredData = filteredData.filter(row => row.type !== "balloonport");
				}

				if (!heliportFilter) {
					filteredData = filteredData.filter(row => row.type !== "heliport");
				}

				if (openFilter) {
					filteredData = filteredData.filter(row => row.type !== "closed");
				}

				if (seaplaneFilter) {
					filteredData = filteredData.filter(row => row.type === "seaplane_base");
				}

				if (minSize === "Large") {
					filteredData = filteredData.filter(row => row.type === "large_airport");
				} else if (minSize === "Medium") {
					filteredData = filteredData.filter(row => row.type === "large_airport" || row.type === "medium_airport");
				}

				if (countryFilter) {
					filteredData = filteredData.filter(row => row.iso_country === countryFilter);
				}

				if (continentFilter) {
					filteredData = filteredData.filter(row => row.continent === continentFilter);
				}

				document.getElementById("rowcount").innerText = `${filteredData.length} airports matching`;

				if (filteredData.length < 1) {
					document.getElementById("result").innerText = "No rows match the filters.";
					console.error("Filtering failed: No rows match the filters.");
				}
			}

			function selectRandom() {
				return filteredData[Math.floor(Math.random() * filteredData.length)];
			}

			function createResult(airport, verbose = true) {
				let result = `<span class="highlight">Name:</span> ${airport.name || "N/A"} <br>
				<span class="highlight">Type:</span> ${airport.type || "N/A"} <br>
				<span class="highlight">IATA:</span> ${airport.iata_code || "N/A"} <br>
				<span class="highlight">Local Code:</span> ${airport.local_code || "N/A"} <br>
				<span class="highlight">Ident:</span> ${airport.ident || "N/A"} <br>
				<span class="highlight">Country:</span> ${countries[airport.iso_country] || "N/A"} <br>
				<span class="highlight">Region:</span> ${airport.iso_region || "N/A"} <br>`;
				if (verbose) {
					result += `
					<span class="highlight">Continent:</span> ${airport.continent || "N/A"} <br>
					<span class="highlight">Home Page:</span> ${airport.home_link ? `<a href="${airport.home_link}" target="_blank">${airport.home_link}</a>` : "-"} <br>
					<span class="highlight">Wikipedia:</span> ${airport.wikipedia_link ? `<a href="${airport.wikipedia_link}" target="_blank">LINK</a>` : "-"}`;
				}
				return result;
			}

			function filterAndSelect() {
				document.querySelectorAll('#step').forEach(element => element.remove());

				filter();

				const randomRow = selectRandom();

				document.getElementById("result").innerHTML = createResult(randomRow);

				lastcoord = {
					lat: randomRow.latitude_deg,
					lon: randomRow.longitude_deg
				};
				console.log("Selected: ", lastcoord);

				initMap(randomRow.latitude_deg, randomRow.longitude_deg);
			}

			async function initMap(p_lat, p_lon) {
				p_lat = parseFloat(p_lat);
				p_lon = parseFloat(p_lon);

				if (isNaN(p_lat) || isNaN(p_lon)) {
					console.error("Invalid latitude or longitude values:", p_lat, p_lon);
					return;
				}

				var location = { lat: p_lat, lng: p_lon };
				var map = new google.maps.Map(document.getElementById('map'), {
					zoom: 10,
					center: location
				});
				var marker = new google.maps.Marker({
					position: location,
					map: map
				});
			}

			function toRadians(degrees) {
				return degrees * Math.PI / 180;
			}

			function calcDistance(lat1, lon1, lat2, lon2) {
				const R = 6371; // Earth radius

				const lat1Rad = toRadians(lat1);
				const lon1Rad = toRadians(lon1);
				const lat2Rad = toRadians(lat2);
				const lon2Rad = toRadians(lon2);

				const dLat = lat2Rad - lat1Rad;
				const dLon = lon2Rad - lon1Rad;

				// Haversine formula
				const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
					Math.cos(lat1Rad) * Math.cos(lat2Rad) *
					Math.sin(dLon / 2) * Math.sin(dLon / 2);
				const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

				let distance = R * c; // km

				if (document.getElementById("unit_nm").checked) {
					distance = distance * 0.539956803;
				}

				return distance;
			}

			function populateFilters() {
				const countrySet = Array.from(new Set(data.map(row => row.iso_country).filter(Boolean))).sort();
				const continentSet = Array.from(new Set(data.map(row => row.continent))).sort();

				const countryFilter = document.getElementById("countryFilter");
				const continentFilter = document.getElementById("continentFilter");

				countryFilter.innerHTML = '<option value="">Any</option>';
				continentFilter.innerHTML = '<option value="">Any</option>';

				countrySet.forEach(country => {
					const option = document.createElement("option");
					option.value = country;
					option.textContent = countries[country];
					countryFilter.appendChild(option);
				});

				continentSet.forEach(continent => {
					const option = document.createElement("option");
					option.value = continent;
					option.textContent = continent;
					continentFilter.appendChild(option);
				});
			}

			function addStep() {
				const min = document.getElementById("minDistance").value;
				const max = document.getElementById("maxDistance").value;
				let randomRow = null;
				let dist = 0;
				let unit = document.getElementById("unit_km").checked ? "km" : "nm";
				let count = 0;

				do {
					randomRow = selectRandom();
					dist = calcDistance(randomRow.latitude_deg, randomRow.longitude_deg, lastcoord.lat, lastcoord.lon);

					if (dist < min || dist > max) {
						console.log(`Attempt #${++count}, distance: ${dist}`);
					}
				} while (dist < min || dist > max);
				dist = Math.round(dist);

				lastcoord = {
					lat: randomRow.latitude_deg,
					lon: randomRow.longitude_deg
				};

				var newstep = createResult(randomRow, false);
				var trow = document.getElementById("trow");
				const content = document.createElement("div");
				content.innerHTML = `<td> &rarr; ${dist} ${unit} <hr/> ${newstep}</td>`;
				const cell = document.createElement("td");
				cell.id = "step";
				cell.appendChild(content);
				trow.appendChild(cell);
			}

			window.onload = loadCSV;
		</script>
	</head>
	<body>
		<h1>Random Airport Selector</h1>

		<table border=0 cellpadding=10>
		<tr id="trow" valign=top><td>

		<label> <input type="checkbox" id="iataFilter"> Only with IATA </label>

		<label> <input type="checkbox" id="balloonFilter"> Enable balloonports </label>

		<label> <input type="checkbox" id="heliportFilter"> Enable heliports </label>

		<label> <input type="checkbox" id="openFilter"> Only open airports </label>

		<label> <input type="checkbox" id="seaplaneFilter"> Only seaplane bases </label>

		<label for="minSize">Minimum size:
		<select id="minSize">
			<option value="All">All</option>
			<option value="Medium">Medium</option>
			<option value="Large">Large</option>
		</select></label>

		<label for="countryFilter">Country:
		<select id="countryFilter">
			<option value="">Any</option>
		</select></label>

		<label for="continentFilter">Continent:
		<select id="continentFilter">
			<option value="">Any</option>
		</select></label>

		<button onclick="filterAndSelect()">Select Random Airport</button>

		<p>
		<button onclick="filter()">Filter</button>
		<button onclick="clearFilter()">Clear filters</button>

		<p><div id="rowcount"></div>

		</td><td>

		<div id="result">Result will be displayed here.</div>

		</td>

		<td style="border: 1px solid black;">
			<h3><u>Route</u></h3>
			<p>Distance:</p>
			<p>
				<label> <input type="radio" id="unit_km" name="unit" value="km" checked="checked"/> km </label>
				<label> <input type="radio" id="unit_nm" name="unit" value="nm"/> nm </label>
			</p>

			<p>
				<label>Min: <input type="number" id="minDistance" min=0 max=10000 value=50></label>
				<label>Max: <input type="number" id="maxDistance" min=50 max=20000 value=500></label>
			</p>

			<p><button onclick="addStep()">Add step</button><p>
		</td>


		</tr></table>

		<div id="map"></div>

		<p><small>Data source: <a href="https://davidmegginson.github.io/ourairports-data">https://davidmegginson.github.io/ourairports-data</a></small></p>

	</body>
</html>

